var g=Object.defineProperty;var v=(d,t,e)=>t in d?g(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var o=(d,t,e)=>v(d,typeof t!="symbol"?t+"":t,e);import{O as x,R as T,V as C,C as u,a as w,B as b,T as m,M as h,L as M,G as L,S as P,P as I,b as k,F as f,W as E,c as S,d as A,e as F,f as G,g as O,I as j,h as c,Q as p,E as H,i as z,A as B,D,j as R,k as U}from"./index-CpDY6dpF.js";class K{constructor(t){o(this,"textures",{});o(this,"isPlaying",!1);o(this,"hasShownText5",!1);o(this,"isLeftAndDownKeyActive",!1);o(this,"canShowText4",!1);o(this,"isFlowerOneClickable",!1);o(this,"flowerOne",null);o(this,"flowerTwo",null);o(this,"cachedNewFlower",null);o(this,"endMessageCompleted",!1);o(this,"allPetalsRemoved",!1);o(this,"clickCounter",0);o(this,"isFirstLoad",!0);o(this,"isFirstClick",!0);o(this,"newFlowerPetals",[]);o(this,"isInteractionEnabled",!0);o(this,"controlsEnabled",!1);o(this,"firstPersonControls");o(this,"loadingManager");o(this,"textureLoader");o(this,"gltfLoader");o(this,"camera");o(this,"renderer");o(this,"scene");o(this,"canvas");o(this,"stats");o(this,"lastFlowerPosition",null);o(this,"existingFlowers",[]);o(this,"sceneProps",{fogColor:"#eeeeee",terrainColor:"#5e875e",fogDensity:.02});o(this,"keyStates",{});o(this,"flowerMesh",new x);o(this,"targetPosition",null);o(this,"raycaster",new T);o(this,"mouse",new C);o(this,"flowerCount",1);o(this,"isFlowerSelected",!1);o(this,"flowerPetals",[]);o(this,"hasReachedTarget",!1);o(this,"gui");o(this,"sceneGUI");o(this,"cameraPositionGUI",{});o(this,"cameraRotationGUI",{});o(this,"guiControls",{});o(this,"Uniforms",{uTime:{value:0},color:{value:new u("#0000ff")}});o(this,"clock",new w);o(this,"boundary",{xMin:-10,xMax:10,yMin:0,yMax:50,zMin:-10,zMax:10});o(this,"movementSpeed",5);o(this,"cameraHeightAboveTerrain",2.2);o(this,"terrainMesh");o(this,"grassMaterial");o(this,"grassGeometry",new b);o(this,"grassCount",5e3);o(this,"flowerBasePosition",new c(7.5,5.4,-10));o(this,"flowerTargetPosition",this.flowerBasePosition.clone());this.textureLoader=new m,this.loadTextures(),this.onGlobalClick=this.onGlobalClick.bind(this),this.terrainMesh=new h,this.loadingManager=new M,this.textureLoader=new m(this.loadingManager),this.gltfLoader=new L(this.loadingManager),this.canvas=t,this.disableControls(),this.stats=new P({minimal:!0}),this.camera=new I(75,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(7.8,5,8.3),this.scene=new k,this.scene.background=new u(this.sceneProps.fogColor),this.scene.fog=new f(this.sceneProps.fogColor,this.sceneProps.fogDensity),this.renderer=new E({canvas:this.canvas,antialias:!0,alpha:!0}),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=S,this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),window.addEventListener("keydown",e=>this.keyStates[e.key]=!0),window.addEventListener("keyup",e=>this.keyStates[e.key]=!1),this.firstPersonControls=new A(this.camera,this.canvas),this.firstPersonControls.movementSpeed=this.movementSpeed,this.firstPersonControls.lookSpeed=.1,this.firstPersonControls.activeLook=!1,this.firstPersonControls.lookVertical=!0,this.firstPersonControls.constrainVertical=!0,this.firstPersonControls.verticalMin=1,this.firstPersonControls.verticalMax=2,this.grassMaterial=new F,this.terrainMesh.material=new G({color:this.sceneProps.terrainColor}),this.canvas.addEventListener("mousemove",e=>this.onMouseMove(e)),this.canvas.addEventListener("click",this.onGlobalClick.bind(this)),this.init(),this.loadTerrain(),this.animateFogEffect().then(()=>{setTimeout(()=>{this.showText0(()=>{document.getElementById("canvas").style.pointerEvents="auto"})},1500)}),this.setupTextures()}setupCameraControls(){const t=this.gui.addFolder("Camera Controls");this.cameraPositionGUI={x:t.add(this.camera.position,"x",-100,100,.1).name("Position X"),y:t.add(this.camera.position,"y",-100,100,.1).name("Position Y"),z:t.add(this.camera.position,"z",-100,100,.1).name("Position Z")},this.cameraRotationGUI={x:t.add(this.camera.rotation,"x",-Math.PI,Math.PI,.01).name("Rotation X"),y:t.add(this.camera.rotation,"y",-Math.PI,Math.PI,.01).name("Rotation Y"),z:t.add(this.camera.rotation,"z",-Math.PI,Math.PI,.01).name("Rotation Z")},t.open()}enableControls(){this.controlsEnabled=!0}disableControls(){this.controlsEnabled=!1}animateFogEffect(){return new Promise(t=>{if(!this.scene.fog||!(this.scene.fog instanceof f)){console.error("Fog is not set or is not of type FogExp2."),t();return}const e=3e3,s=.3,i=this.sceneProps.fogDensity,a=new w,n=()=>{const r=a.getElapsedTime()*1e3,l=Math.min(r/e,1);this.scene.fog.density=U.lerp(s,i,l),l<1?requestAnimationFrame(n):t()};n()})}loadModels(){this.sceneGUI.addColor(this.sceneProps,"terrainColor").onChange(t=>{this.terrainMesh.material.color.set(t)}),this.loadTerrain(()=>{this.loadGrass(),this.loadFlowers()})}loadTerrain(t){this.gltfLoader.load("/island.glb",e=>{e.scene.traverse(s=>{s instanceof h&&(s.receiveShadow=!0,s.castShadow=!0,s.geometry.scale(3,3,3),this.terrainMesh=s)}),this.scene.add(e.scene),console.log("Terrain loaded"),t&&t()})}loadGrass(){this.gltfLoader.load("/grassLODs.glb",t=>{t.scene.traverse(e=>{e instanceof h&&e.name.includes("LOD00")&&(e.geometry.scale(5,5,5),this.grassGeometry=e.geometry)}),this.terrainMesh&&this.grassGeometry&&this.addGrass(this.terrainMesh,this.grassGeometry)})}addGrass(t,e){const s=new O(t).setWeightAttribute("color").build(),i=new j(e,this.grassMaterial.material,this.grassCount);i.receiveShadow=!0;const a=new c,n=new p,r=new c(1,1,1);for(let l=0;l<this.grassCount;l++)s.sample(a,new c),n.setFromUnitVectors(new c(0,1,0),new c),n.multiply(new p().setFromEuler(new H(0,Math.random()*Math.PI*2,0))),i.setMatrixAt(l,new z().compose(a,n,r));this.scene.add(i)}loadFlowers(){this.gltfLoader.load("/flower.glb",t=>{if(this.flowerMesh=t.scene,!this.flowerMesh)return;const e=this.flowerMesh.clone();e.traverse(a=>{a instanceof h&&(a.castShadow=!0,a.receiveShadow=!1)}),e.position.set(7.8,0,-11.7);const s=1.5;e.scale.set(s,1.8,s),e.lookAt(this.camera.position),e.rotateX(-Math.PI/-8),e.rotateY(Math.PI/-16);const i=this.flowerMesh.clone();i.traverse(a=>{a instanceof h&&(a.castShadow=!0,a.receiveShadow=!1)}),i.position.set(-8,0,-2),i.scale.set(s,1.8,s),i.lookAt(this.camera.position),i.rotateX(-Math.PI/-8),i.rotateY(Math.PI/-16),this.scene.add(e),this.flowerOne=e,this.scene.add(i),this.flowerTwo=i,this.flowerMesh=e})}onMouseMove(t){const e=this.canvas.getBoundingClientRect();this.mouse.x=(t.clientX-e.left)/e.width*2-1,this.mouse.y=-((t.clientY-e.top)/e.height)*2+1,this.flowerTargetPosition.x=this.flowerBasePosition.x+this.mouse.x*.2,this.flowerTargetPosition.y=this.flowerBasePosition.y+this.mouse.y*.1}onGlobalClick(t){if(!this.flowerOne||!this.flowerTwo||this.isPlaying)return;this.isPlaying=!0,setTimeout(()=>{this.isPlaying=!1},3e3),this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.raycaster.intersectObjects([this.flowerOne,this.flowerTwo].flatMap(s=>{const i=[];return s.traverse(a=>i.push(a)),i}),!0);if(e.length>0){const s=e[0].object;let i=!1;this.flowerOne.traverse(n=>{n===s&&(i=!0)});let a=!1;this.flowerTwo.traverse(n=>{n===s&&(a=!0)}),i?this.isFlowerOneClickable&&(console.log("Clicked on flowerOne"),this.controlsEnabled=!1,this.moveCameraTowardsTarget(()=>{this.showText3(),this.controlsEnabled=!0})):a&&(console.log("Clicked on flowerTwo"),this.controlsEnabled=!1,this.showText5())}}showText0(t){const e=`In such a wide grassland,
I noticed this ugly flower at first glance.`,s=document.createElement("div");s.id="text0",s.style.position="fixed",s.style.textTransform="uppercase",s.style.fontSize="90px",s.style.fontWeight="bold",s.style.color="red",s.style.opacity="1",s.style.transition="opacity 0.5s ease",document.body.appendChild(s),this.disableInteraction(),new Audio("./sound/text1.mp3").play().catch(r=>{console.error("Audio playback failed:",r)});let a=0;const n=setInterval(()=>{const r=e.charAt(a);r===`
`?s.innerHTML+="<br>":s.innerHTML+=r,a++,a>=e.length&&(clearInterval(n),setTimeout(()=>{this.fadeOutText(s,()=>{this.enableInteraction(),this.showArrowHint(),t&&t()})},1e3))},80)}showText2(){const t=`I’m sure it possesses a one-of-a-kind ordinariness in this world, just as ordinary as I am.
So I walk straight toward it.`,e=document.createElement("div");e.id="text2",e.style.position="fixed",e.style.textTransform="uppercase",e.style.fontSize="90px",e.style.fontWeight="bold",e.style.color="red",e.style.opacity="1",e.style.transition="opacity 0.5s ease",document.body.appendChild(e),new Audio("./sound/text2.mp3").play().catch(n=>{console.error("Audio playback failed:",n)});let i=0;const a=setInterval(()=>{let n=t.charAt(i);n===`
`?e.innerHTML+="<br>":e.innerHTML+=n,i++,i>=t.length&&(clearInterval(a),setTimeout(()=>{this.fadeOutText(e)},1e3),this.isFlowerOneClickable=!0,this.enableControls())},60)}showText3(){const t=`in this moment, i am no longer alone. 
i have no need to seek answers.`,e=document.createElement("div");e.id="text3",e.style.position="fixed",e.style.textTransform="uppercase",e.style.fontSize="90px",e.style.fontWeight="bold",e.style.color="red",e.style.opacity="1",e.style.transition="opacity 0.5s ease",document.body.appendChild(e),new Audio("./sound/text3.mp3").play().catch(n=>{console.error("Audio playback failed:",n)});let i=0;const a=setInterval(()=>{let n=t.charAt(i);n===`
`?e.innerHTML+="<br>":e.innerHTML+=n,i++,i>=t.length&&(clearInterval(a),setTimeout(()=>{this.fadeOutText(e),this.canShowText4=!0,this.triggerKeyBounce()},1e3),this.enableControls())},60)}triggerKeyBounce(){this.isLeftAndDownKeyActive=!0;const t=document.getElementById("arrow-left"),e=document.getElementById("arrow-down");t&&t.classList.add("jumping"),e&&e.classList.add("jumping")}checkKeyBounceStopConditions(){if(!this.isLeftAndDownKeyActive)return;const t=document.getElementById("arrow-left"),e=document.getElementById("arrow-down");this.camera.position.x<1&&(t!=null&&t.classList.contains("jumping"))&&t.classList.remove("jumping"),this.camera.position.z>4&&(e!=null&&e.classList.contains("jumping"))&&e.classList.remove("jumping");const s=t==null?void 0:t.classList.contains("jumping"),i=e==null?void 0:e.classList.contains("jumping");!s&&!i&&(this.isLeftAndDownKeyActive=!1)}showText4(){const t=`for I’ve found peace within myself,
expecting nothing from it.`,e=document.createElement("div");e.id="text4",e.style.position="fixed",e.style.textTransform="uppercase",e.style.fontSize="90px",e.style.fontWeight="bold",e.style.color="red",e.style.opacity="1",e.style.transition="opacity 0.5s ease",document.body.appendChild(e),new Audio("./sound/text4.mp3").play().catch(n=>{console.error("Audio playback failed:",n)});let i=0;const a=setInterval(()=>{let n=t.charAt(i);n===`
`?e.innerHTML+="<br>":e.innerHTML+=n,i++,i>=t.length&&(clearInterval(a),setTimeout(()=>{this.fadeOutText(e)},1e3),this.enableControls())},60)}showText5(){const t=`Loves me, loves me not...
Whatever.
I’m just another ugly flower in this grassland, too.`,e=document.createElement("div");e.id="text5",e.style.position="fixed",e.style.textTransform="uppercase",e.style.fontSize="90px",e.style.fontWeight="bold",e.style.color="red",e.style.opacity="1",e.style.transition="opacity 0.5s ease",document.body.appendChild(e),new Audio("./sound/finaltext.mp3").play().catch(n=>{console.error("Audio playback failed:",n)});let i=0;const a=setInterval(()=>{let n=t.charAt(i);n===`
`?e.innerHTML+="<br>":e.innerHTML+=n,i++,i>=t.length&&(clearInterval(a),setTimeout(()=>{this.fadeOutText(e,()=>{setTimeout(()=>{if(!this.hasShownText5){this.hasShownText5=!0;const r=document.querySelector(".triangle-mini");r&&(r.style.borderTop="35px solid red",new Audio("./sound/start.mp3").play().catch(y=>{console.error("Start audio playback failed:",y)}),r.addEventListener("click",()=>{window.location.reload()}))}},2e3)})},1e3),this.enableControls())},60)}fadeOutText(t,e){let s=1;const i=setInterval(()=>{s-=.08,t.style.opacity=s.toString(),s<=0&&(clearInterval(i),t.style.display="none",e&&e())},50)}moveCameraTowardsTarget(t){this.targetPosition=new c(7.8,5,-2.2);const e=setInterval(()=>{if(this.targetPosition){const s=new c().subVectors(this.targetPosition,this.camera.position).normalize();this.camera.position.distanceTo(this.targetPosition)<.1?(this.camera.position.copy(this.targetPosition),clearInterval(e),t()):this.camera.position.addScaledVector(s,.01)}},16)}showNewFlowerText(){const t=`I WALK STRAIGHT TOWARD IT,
PLUCKING IT AS IF IN AN ENDLESS CYCLE.`,e=document.createElement("div");e.id="new-flower-text",e.style.position="fixed",e.style.fontSize="90px",e.style.fontWeight="bold",e.style.color="red",e.style.opacity="1",e.style.transition="opacity 0.5s ease",document.body.appendChild(e),new Audio("./sound/message3.mp3").play().catch(r=>{console.error("Audio playback failed:",r)});let i=0;const a=setInterval(()=>{const r=t.charAt(i);r===`
`?e.innerHTML+="<br>":e.innerHTML+=r,i++,i>=t.length&&(clearInterval(a),setTimeout(()=>n(),1e3))},65),n=()=>{e.style.opacity="0",setTimeout(()=>{document.body.removeChild(e),this.enableInteraction()},500)}}animateFlowerAppearance(t,e){const a=Math.floor(e/.3);let n=0;const r=()=>{if(n<a){const l=Math.min(n/a*3,3);t.scale.set(l,l,l),n++,requestAnimationFrame(r)}};r()}disableInteraction(){this.canvas.style.pointerEvents="none",window.addEventListener("keydown",this.preventKeyEvent,!0),window.addEventListener("keyup",this.preventKeyEvent,!0),this.isInteractionEnabled=!1,this.firstPersonControls.enabled=!1}enableInteraction(){this.canvas.style.pointerEvents="auto",window.removeEventListener("keydown",this.preventKeyEvent,!0),window.removeEventListener("keyup",this.preventKeyEvent,!0),this.isInteractionEnabled=!0,this.firstPersonControls.enabled=!0}preventKeyEvent(t){t.preventDefault(),t.stopPropagation()}moveCameraTowardsFlower(){if(!this.targetPosition)return;const t=new c().subVectors(this.targetPosition,this.camera.position).normalize(),e=this.camera.position.distanceTo(this.targetPosition),s=Math.min(e,.1);this.camera.position.addScaledVector(t,s),e<.1&&(this.targetPosition=null,this.hasReachedTarget=!0)}animate(){requestAnimationFrame(()=>this.animate());const t=this.clock.getDelta();this.firstPersonControls.update(t);const e=[this.flowerOne,this.flowerTwo];let s=!1;e.forEach(i=>{if(i&&this.isFlowerOneClickable){this.raycaster.setFromCamera(this.mouse,this.camera),this.raycaster.intersectObject(i,!0).length>0&&(s=!0);const n=.05,r=1.5;i.rotation.y=Math.sin(this.clock.elapsedTime*r)*n,i.rotation.z=Math.sin(this.clock.elapsedTime*r*.3)*n}}),this.canvas.style.cursor=s?"pointer":"default",this.targetPosition&&this.moveCameraTowardsFlower(),this.grassMaterial&&this.grassMaterial.uniforms&&(this.grassMaterial.uniforms.uTime.value+=t*.4),this.checkKeyBounceStopConditions(),this.renderer.render(this.scene,this.camera)}updateCameraHeight(){this.raycaster.set(this.camera.position,new c(0,-1,0));const t=this.raycaster.intersectObject(this.terrainMesh,!0);if(t.length>0){const e=t[0].point.y,s=.1;this.camera.position.y+=(e+this.cameraHeightAboveTerrain-this.camera.position.y)*s}}addLights(){const t=new B(16777215,.5);this.scene.add(t);const e=new D(16777215,2);e.castShadow=!0,e.position.set(100,100,100),e.shadow.camera.far=200,e.shadow.camera.left=-50,e.shadow.camera.right=50,e.shadow.camera.top=50,e.shadow.camera.bottom=-50,e.shadow.mapSize.set(2048,2048),this.scene.add(e)}loadTextures(){this.textures.perlinNoise=this.textureLoader.load("/perlinnoise.webp"),this.textures.grassAlpha=this.textureLoader.load("/grass.jpeg")}setupTextures(){this.textures.perlinNoise=this.textureLoader.load("/perlinnoise.webp"),this.textures.grassAlpha=this.textureLoader.load("/grass.jpeg"),this.grassMaterial.setupTextures(this.textures.grassAlpha,this.textures.perlinNoise)}setupGUI(){const t=document.createElement("style");t.textContent=`
            .dg.ac { 
                display: none !important; /* 隐藏 GUI */
            }
        `,document.head.appendChild(t),this.gui=new R,this.sceneGUI=this.gui.addFolder("Scene Properties"),this.sceneGUI.addColor(this.sceneProps,"terrainColor").onChange(e=>{this.terrainMesh&&this.terrainMesh.material&&this.terrainMesh.material.color?this.terrainMesh.material.color.set(e):console.warn("Terrain material or color is not available.")}),this.sceneGUI.add(this.sceneProps,"fogDensity",0,.05,1e-6).onChange(e=>{this.scene.fog.density=e})}setupEventListeners(){window.addEventListener("resize",()=>this.setAspectResolution(),!1),window.addEventListener("keydown",t=>{t.key==="ArrowLeft"&&this.canShowText4&&(this.showText4(),this.canShowText4=!1)})}setAspectResolution(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}init(){this.setupTextures(),this.setupGUI(),this.setupCameraControls(),this.loadModels(),this.setupEventListeners(),this.addLights(),this.animate()}showArrowHint(){const t=document.createElement("div");t.id="arrow-hint",t.innerHTML=`
      <div class="row">
        <div class="arrow-key jumping" id="arrow-up">↑</div>
      </div>
      <div class="row">
        <div class="arrow-key" id="arrow-left">←</div>
        <div class="arrow-key" id="arrow-down">↓</div>
        <div class="arrow-key" id="arrow-right">→</div>
      </div>
    `,document.body.appendChild(t);const e=document.createElement("style");e.textContent=`
      #arrow-hint {
        position: fixed;
        bottom: 20px;
        left: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        z-index: 1000;
      }

      .row {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }

      .arrow-key {
        width: 40px;
        height: 40px;
        background-color: rgba(245, 245, 245, 0.8);
        color: black;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 5px;
        font-size: 24px;
        font-weight: bold;
        transition: background-color 0.2s ease, transform 0.2s ease;
      }

      .arrow-key.jumping {
        animation: arrowBounce 1s infinite;
      }

      .arrow-key.active {
        background-color: rgba(0, 0, 0, 0.3);
        color: white; /* 可选：改变文字颜色 */
      }

      @keyframes arrowBounce {
        0%, 100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }
    `,document.head.appendChild(e),this.addArrowKeyListeners()}addArrowKeyListeners(){const t={ArrowUp:"arrow-up",ArrowLeft:"arrow-left",ArrowDown:"arrow-down",ArrowRight:"arrow-right"};window.addEventListener("keydown",e=>{const s=t[e.key];if(s){const i=document.getElementById(s);i&&(i.classList.add("active"),s==="arrow-up"&&i.classList.contains("jumping")&&(i.classList.remove("jumping"),this.showText2()))}}),window.addEventListener("keyup",e=>{const s=t[e.key];if(s){const i=document.getElementById(s);i&&i.classList.remove("active")}})}}const W=document.querySelector("#canvas");new K(W);export{K as Scene2};
